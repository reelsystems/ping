{
  "name": "systemLdapAccount_managedUser",
  "displayName": "Active Directory to Managed User",
  "description": "Synchronization mapping from Active Directory accounts to managed users",
  "source": "system/ActiveDirectory/account",
  "target": "managed/user",
  "linkQualifiers": [
    "default"
  ],
  "validSource": {
    "type": "text/javascript",
    "source": "source.userAccountControl != null && (source.userAccountControl & 2) == 0"
  },
  "validTarget": {
    "type": "text/javascript",
    "source": "!!target"
  },
  "correlationQuery": [
    {
      "linkQualifier": "default",
      "type": "text/javascript",
      "source": "var query = {'_queryFilter': 'userName eq \"' + source.sAMAccountName + '\"'}; query;"
    }
  ],
  "properties": [
    {
      "source": "sAMAccountName",
      "target": "userName",
      "comment": "Map AD sAMAccountName to userName"
    },
    {
      "source": "cn",
      "target": "displayName",
      "comment": "Map common name to display name"
    },
    {
      "source": "givenName",
      "target": "givenName",
      "comment": "First name"
    },
    {
      "source": "sn",
      "target": "sn",
      "comment": "Last name"
    },
    {
      "source": "mail",
      "target": "mail",
      "condition": {
        "type": "text/javascript",
        "source": "!!source.mail"
      },
      "comment": "Email address"
    },
    {
      "source": "telephoneNumber",
      "target": "telephoneNumber",
      "condition": {
        "type": "text/javascript",
        "source": "!!source.telephoneNumber"
      },
      "comment": "Phone number"
    },
    {
      "source": "mobile",
      "target": "mobile",
      "condition": {
        "type": "text/javascript",
        "source": "!!source.mobile"
      },
      "comment": "Mobile number"
    },
    {
      "source": "title",
      "target": "title",
      "condition": {
        "type": "text/javascript",
        "source": "!!source.title"
      },
      "comment": "Job title"
    },
    {
      "source": "department",
      "target": "department",
      "condition": {
        "type": "text/javascript",
        "source": "!!source.department"
      },
      "comment": "Department"
    },
    {
      "source": "company",
      "target": "organization",
      "condition": {
        "type": "text/javascript",
        "source": "!!source.company"
      },
      "comment": "Organization/Company"
    },
    {
      "source": "objectGUID",
      "target": "externalId",
      "comment": "AD objectGUID for linking"
    },
    {
      "target": "accountStatus",
      "transform": {
        "type": "text/javascript",
        "source": "source.userAccountControl != null && (source.userAccountControl & 2) == 0 ? 'active' : 'inactive';"
      },
      "comment": "Map account status based on userAccountControl"
    },
    {
      "source": "memberOf",
      "target": "groups",
      "transform": {
        "type": "text/javascript",
        "source": "if (source.memberOf != null) { var groups = []; for (var i = 0; i < source.memberOf.length; i++) { var dn = source.memberOf[i]; var cn = dn.split(',')[0].split('=')[1]; groups.push(cn); } groups; } else { []; }"
      },
      "comment": "Extract group names from memberOf DNs"
    }
  ],
  "policies": [
    {
      "situation": "CONFIRMED",
      "action": "UPDATE",
      "comment": "Update existing managed user"
    },
    {
      "situation": "FOUND",
      "action": "UPDATE",
      "comment": "Link and update found user"
    },
    {
      "situation": "ABSENT",
      "action": "CREATE",
      "comment": "Create new managed user"
    },
    {
      "situation": "AMBIGUOUS",
      "action": "EXCEPTION",
      "comment": "Multiple matches - requires manual resolution"
    },
    {
      "situation": "MISSING",
      "action": "DELETE",
      "comment": "AD user no longer exists - delete managed user",
      "postMapping": {
        "type": "text/javascript",
        "source": "logger.info('Deleting managed user: ' + target.userName);"
      }
    },
    {
      "situation": "SOURCE_MISSING",
      "action": "DELETE",
      "comment": "Source object is missing"
    },
    {
      "situation": "UNQUALIFIED",
      "action": "IGNORE",
      "comment": "Source not qualified (disabled account)"
    },
    {
      "situation": "UNASSIGNED",
      "action": "IGNORE",
      "comment": "Target not qualified"
    }
  ],
  "onCreate": {
    "type": "text/javascript",
    "source": "logger.info('Created managed user from AD: ' + object.userName);"
  },
  "onUpdate": {
    "type": "text/javascript",
    "source": "logger.info('Updated managed user from AD: ' + object.userName);"
  },
  "onDelete": {
    "type": "text/javascript",
    "source": "logger.info('Deleted managed user (AD source removed): ' + object.userName);"
  },
  "onLink": {
    "type": "text/javascript",
    "source": "logger.info('Linked AD account to managed user: ' + object.userName);"
  },
  "onUnlink": {
    "type": "text/javascript",
    "source": "logger.info('Unlinked AD account from managed user: ' + object.userName);"
  }
}
